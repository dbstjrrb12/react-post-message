name: PR Changelog Check

on:
  pull_request:
    types: [opened, synchronize] # PRì´ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ
    branches:
      - develop # develop ë¸Œëžœì¹˜ë¡œì˜ PRì¼ ë•Œë§Œ

jobs:
  check-changelog:
    name: Check Changeset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # PRì˜ ë³€ê²½ì‚¬í•­ê³¼ ì´ì „ ì»¤ë°‹ë§Œ í•„ìš”

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: Detect Changes
        id: changes
        run: |
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          cat changed_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for Changeset
        id: check-changeset
        run: |
          if pnpm changeset status; then
            echo "has_changeset=true" >> $GITHUB_OUTPUT
          else
            echo "has_changeset=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Version Selection Comment
        if: steps.check-changeset.outputs.has_changeset == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const changedFiles = `${{ steps.changes.outputs.changed_files }}`;

            if (!changedFiles) {
              return;
            }

            const body = `## ðŸ”„ ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!

            ë‹¤ìŒ íŒŒì¼ë“¤ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤:
            \`\`\`
            ${changedFiles}
            \`\`\`

            ### ë²„ì „ ì—…ë°ì´íŠ¸ íƒ€ìž…ì„ ì„ íƒí•´ì£¼ì„¸ìš”:

            ì•„ëž˜ ì½”ë©˜íŠ¸ ì¤‘ í•˜ë‚˜ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
            - \`/changeset major\` - ì£¼ìš” ë³€ê²½ì‚¬í•­ (Breaking Changes)
            - \`/changeset minor\` - ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€
            - \`/changeset patch\` - ë²„ê·¸ ìˆ˜ì •

            ì„ íƒí•˜ì‹œë©´ ìžë™ìœ¼ë¡œ changesetì´ ìƒì„±ë©ë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body
            });

      - name: Handle Version Selection
        if: steps.check-changeset.outputs.has_changeset == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const handleVersionSelection = async ({ comment }) => {
              const versionTypes = ['major', 'minor', 'patch'];
              const commentBody = comment.body.trim().toLowerCase();
              
              if (!commentBody.startsWith('/changeset')) {
                return;
              }

              const type = commentBody.split(' ')[1];
              if (!versionTypes.includes(type)) {
                return;
              }

              // ì—¬ê¸°ì„œ changeset ìƒì„± ëª…ë ¹ ì‹¤í–‰
              const exec = require('child_process').execSync;
              try {
                exec(`pnpm changeset add --${type}`);
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  body: `âœ… ${type} íƒ€ìž…ì˜ changesetì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`
                });
              } catch (error) {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  body: `âŒ changeset ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`
                });
              }
            };

            // PR ì½”ë©˜íŠ¸ ì´ë²¤íŠ¸ êµ¬ë…
            github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
            }).then(({ data: comments }) => {
              comments.forEach(handleVersionSelection);
            });
