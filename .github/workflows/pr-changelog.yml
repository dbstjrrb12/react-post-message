name: PR Changelog Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  check-changelog:
    name: Check Changeset
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'develop') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.issue.pull_request.base.ref == 'develop')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Debug Event
        run: |
          echo "Event Type: ${{ github.event_name }}"
          echo "PR Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "PR Head Branch: ${{ github.event.pull_request.head.ref }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git fetch origin develop:develop

      - name: Detect Changes
        id: changes
        run: |
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          git diff --name-only origin/develop ${{ github.event.pull_request.head.sha }} > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

          # packages ë””ë ‰í† ë¦¬ ë‚´ì˜ ë³€ê²½ì‚¬í•­ë§Œ í•„í„°ë§
          grep "^packages/" changed_files.txt > package_changes.txt || true
          echo "Package changes:"
          cat package_changes.txt

          # changeset íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (README.md ì œì™¸)
          find .changeset -name "*.md" ! -name "README.md" > changeset_files.txt 2>/dev/null || true
          echo "Changeset files:"
          cat changeset_files.txt

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          cat changed_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "package_changes<<EOF" >> $GITHUB_OUTPUT
          cat package_changes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "has_changeset<<EOF" >> $GITHUB_OUTPUT
          if [ -s changeset_files.txt ]; then
            echo "true" >> $GITHUB_OUTPUT
          else
            echo "false" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Debug Outputs
        run: |
          echo "Package Changes Output:"
          echo "${{ steps.changes.outputs.package_changes }}"
          echo "Has Changeset Output:"
          echo "${{ steps.changes.outputs.has_changeset }}"

      - name: Create Version Selection Comment
        if: steps.changes.outputs.package_changes != '' && steps.changes.outputs.has_changeset == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const changedFiles = `${{ steps.changes.outputs.changed_files }}`;
            const packageChanges = `${{ steps.changes.outputs.package_changes }}`;

            if (!packageChanges) {
              console.log('No package changes detected');
              return;
            }

            const body = `## ğŸ”„ íŒ¨í‚¤ì§€ ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!

            ë‹¤ìŒ íŒ¨í‚¤ì§€ë“¤ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤:
            \`\`\`
            ${packageChanges}
            \`\`\`

            ### ë²„ì „ ì—…ë°ì´íŠ¸ íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”:

            ì•„ë˜ ì½”ë©˜íŠ¸ ì¤‘ í•˜ë‚˜ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
            - \`/changeset major\` - ì£¼ìš” ë³€ê²½ì‚¬í•­ (Breaking Changes)
            - \`/changeset minor\` - ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€
            - \`/changeset patch\` - ë²„ê·¸ ìˆ˜ì •

            ì„ íƒí•˜ì‹œë©´ ìë™ìœ¼ë¡œ changesetì´ ìƒì„±ë©ë‹ˆë‹¤.`;

            const { owner, repo } = context.repo;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: context.issue.number,
              body
            });
